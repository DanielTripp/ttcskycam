<!DOCTYPE html>
<html>
  <head>
		<title>show_points_file</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 70%; margin: 0; padding: 0 }
    </style>
    <script type="text/javascript"
		      src="http://maps.googleapis.com/maps/api/js?sensor=false">
					    </script>
		<script type="text/javascript" src="js/richmarker-compiled.js"></script>
		<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="common.js"></script>
		<script type="text/javascript" src="js/buckets-minified.js"></script>
    <script type="text/javascript">

var g_latlngs = new buckets.LinkedList();
var g_polylines = new buckets.LinkedList();
var g_i = 0;
var g_bounding_rect = null;
var g_dot_opacity = 0.5;

function initialize() {

	init_map();

	google.maps.event.addListener(g_map, 'zoom_changed', redraw_objects);

  $('#filename_field').keydown(function (e){
      if(e.keyCode == 13) {
				forget_drawn_objects();
				get_latlngs_from_file();
				if(false) {
					draw_one_point_at_a_time();
				} else {
					draw_all_points();
				}
      }
    });
}

function get_latlngs_from_file() {
	g_latlngs.clear();
	var contents_str = get_sync(get_value('filename_field'), {cache: false});
	if(contents_str != null) {
		var contents_latlng_list = null;
		try {
			contents_latlng_list = $.parseJSON(contents_str);
		} catch(e) {
			// So it wasn't JSON.    Maybe it's XML: 
			try {
				var dom = $.parseXML(contents_str);
				contents_latlng_list = [];

				$(dom).find('*').each(function() {
					var lat = $(this).attr('lat'), lng = $(this).attr('lon');
					if(lat != undefined && lng != undefined) {
						contents_latlng_list.push([lat, lng]);
					}
				});
			} catch(err) {
				var lines = contents_str.split('\n');
				var latindex = -1; var lngindex = -1;
				var first_line_fields = flatfile_get_fields_from_line(lines[0]);
				for(var fieldidx in first_line_fields) {
					var first_line_field = first_line_fields[fieldidx];
					var floatval = parseFloat(first_line_field);
					if(floatval == NaN) {
						continue;
					}
					if(floatval > -80 && floatval < -78) {
						lngindex = fieldidx;
					} else if(floatval > 43 && floatval < 45) {
						latindex = fieldidx;
					}
					if(latindex != -1 && lngindex != -1) {
						break;
					}
				}

				if(latindex != -1 && lngindex != -1) {
					contents_latlng_list = [];
					for(var i=1; i<lines.length; i++) {
						var line = lines[i];
						var fields = flatfile_get_fields_from_line(line);
						if(fields.length >= Math.max(latindex, lngindex)+1) {
							contents_latlng_list.push([fields[latindex], fields[lngindex]]);
						}
					}
				}
			}
		}
		if(contents_latlng_list != null) {
			for(var i in contents_latlng_list) {
				var raw_latlng = contents_latlng_list[i];
				var glatlng = new google.maps.LatLng(raw_latlng[0], raw_latlng[1]);
				g_latlngs.add(glatlng);
			}
		}
	}
}

function flatfile_get_fields_from_line(line_) {
	var line = line_;
	while(true) {
		var c = line.charAt(line.length-1);
		if(c == '\n' || c == '\r' || c == ' ') {
			line = line.substring(0, line.length-1);
		} else {
			break;
		}
	}
	var r = line.split(',');
	for(var i in r) {
		r[i] = cleanup_field(r[i]);
	}
	return r;
}

function cleanup_field(val_) {
  return val_.replace(/.*?([-]?\d+\.\d+).*/g, "$1");
}

function redraw_objects() {
	forget_drawn_objects();
	draw_all_points();
}

function forget_drawn_objects() {
	g_polylines.forEach(function(e) {
		e.setMap(null);
	});
	g_polylines.clear();
	g_i = 0;

	if(g_bounding_rect != null) {
		g_bounding_rect.setMap(null);
		g_bounding_rect = null;
	}
}

function draw_all_points() {
	var minlat=90, maxlat=0, minlng=0, maxlng=-180;

	var i=0;
	g_latlngs.forEach(function(glatlng) {

		make_line(glatlng, i);

		minlat = Math.min(minlat, glatlng.lat());
		maxlat = Math.max(maxlat, glatlng.lat());
		minlng = Math.min(minlng, glatlng.lng());
		maxlng = Math.max(maxlng, glatlng.lng());

		i += 1;
	});

	var rect_bounds = new google.maps.LatLngBounds(
			new google.maps.LatLng(minlat, minlng), new google.maps.LatLng(maxlat, maxlng));
	g_bounding_rect = new google.maps.Rectangle({bounds: rect_bounds, map: g_map, strokeColor: 'rgb(0,0,0)', 
			strokeOpacity: 0.5, strokeWeight: 1, fillOpacity: 0, zIndex: -10});
}

function make_line(latlng_, i_) {
	var polyline = new google.maps.Polyline({map: g_map, strokeWeight: get_dot_size(), strokeOpacity: g_dot_opacity, 
			path: [latlng_, latlng_]});
	var infowin = new google.maps.InfoWindow({position: polyline.getPath().getAt(0), content: ''+i_, disableAutoPan: true});
	google.maps.event.addListener(polyline, 'mouseover', function() {
		infowin.open(g_map);
	});
	google.maps.event.addListener(polyline, 'mouseout', function() {
		infowin.close();
	});
	g_polylines.add(polyline);
}

function get_dot_size() {
	var zoom = g_map.getZoom();
	if(zoom <= 12) {
		return 10;
	} else {
		return get_range_val(12, 10, 21, 80, zoom);
	}
}

function draw_one_point_at_a_time() {
	var glatlng = g_latlngs.elementAtIndex(g_i);
	//var polyline = new google.maps.Polyline({map: g_map, strokeWeight: 10, strokeOpacity: 0.3, 
	//		path: [glatlng, glatlng]});
	var polyline = new google.maps.Marker({map: g_map, 
			position: glatlng, draggable: true});
	g_polylines.add(polyline);
	g_i += 1;
	if(g_i < g_latlngs.size()) {
		setTimeout("draw_one_point()", 5);
	}
}

function on_opacity_down_clicked() {
	g_dot_opacity = Math.max(g_dot_opacity-0.1, 0.0);
	redraw_objects();
}

function on_opacity_up_clicked() {
	g_dot_opacity = Math.min(g_dot_opacity+0.1, 1.0);
	redraw_objects();
}





    </script>
  </head>
  <body onload="initialize()" >
		<div id="map_canvas" style="width:80%; height:100%"></div>
		<input type="text" size="130" name="filename_field" id="filename_field" />
		<input type="button" onclick="on_opacity_down_clicked()" value="Opacity DOWN" />
		<input type="button" onclick="on_opacity_up_clicked()" value="Opacity UP" />
		<p id="p1"/>
  </body>
</html>
