<!DOCTYPE html>
<html>
  <head>
		<title>TTC</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 70%; margin: 0; padding: 0 }
    </style>
		<script type="text/javascript" src="js/buckets-minified.js"></script>
		<link type="text/css" href="css/ui-lightness/jquery-ui-1.8.17.custom.css" rel="stylesheet" />
    <script type="text/javascript"
      src="http://maps.googleapis.com/maps/api/js?sensor=false">
    </script>
		<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="js/richmarker-compiled.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.8.17.custom.min.js"></script>
		<script type="text/javascript" src="common.js"></script>
		<script type="text/javascript" src="snaptogrid.js"></script>
    <script type="text/javascript">

var g_map;
var g_stop_markers = new buckets.LinkedList(), g_lines = new buckets.LinkedList();
var g_route_markers = new buckets.LinkedList();
var g_snapped_marker = null;
var g_resnapped_markers = [null, null];
var g_stops_dir_to_stoptag_to_latlng = null;
var g_snaptogridcache = new SnapToGridCache([]);


function add_info_win(mark_, text_) {
	(new google.maps.InfoWindow({content: text_, disableAutoPan: true})).open(g_map, mark_);
}

function int_to_rgbstr(int_) {
	var n = int_ % 7;
	var r = '(0,0,0)';
	if(n == 0) {
		r = '255,0,0';
	} else if(n == 1) {
		r = '0,255,0';
	} else if(n == 2) {
		r = '0,0,255';
	} else if(n == 3) {
		r = '255,100,0';
	} else if(n == 4) {
		r = '0,255,255';
	} else if(n == 5) {
		r = '255,0,255';
	} else if(n == 6) {
		r = '100,0,100';
	}
	return 'rgb('+r+')';
}
	
function recreate_slider() {
	$('#slider').slider({
		value: 0, 
		min: 0, max: g_times.length-1, 
		slide: function(event, ui) {
			on_slider_slide(ui.value);
		}
		});
	$("#slider").css("background", "gray");
	on_slider_slide(0);
}

function keypress_handler(e) {
	var pK = e? e.which : window.event.keyCode;
	if(pK == 32) {
		$('#add_marker_button').trigger('click');
		return false;
	} else {
		return true;
	}
}

function initialize() {
	init_map();
	google.maps.event.addListener(g_map, 'click', function(e) {
		add_route_marker(e.latLng);
		rebuild_snaptogridcache();
	});
	init_snaptest_marker();

	document.onkeypress = keypress_handler;
	if (document.layers) {
		document.captureEvents(Event.KEYPRESS); 
	}


/*
  $('#stoptag_field').keydown(function (e){
			if(e.keyCode == 13) {
				$('#stoptag_submit_button').trigger('click');
			}
		});
*/

	google.maps.event.addListener(g_map, 'zoom_changed', on_zoom_changed);
	on_zoom_changed();

}

function show_stoptag(stoptag_) {
	if(g_stops_dir_to_stoptag_to_latlng==null) {
		alert('You need to load a fudgeroute before searching for a stoptag.');
		return;
	}
	for(var dir=0; dir<=1; dir++) {
		var latlng = g_stops_dir_to_stoptag_to_latlng[dir][stoptag_];
		if(latlng != undefined) {
			break;
		}
	}
	if(latlng == undefined) {
		alert('stoptag not found.');
	} else {
		var infowin = new google.maps.InfoWindow({content: sprintf('stoptag %s<br>%f, %f', stoptag_, latlng[0], latlng[1]), 
				position: new google.maps.LatLng(latlng[0], latlng[1])});
		infowin.open(g_map);
	}
}

function init_snaptest_marker() {
	var marker = new google.maps.Marker({
		position: new google.maps.LatLng(43.655, -79.44), 
		map: g_map,
		title:'MOFR',
		draggable: true 
		});
	google.maps.event.addListener(marker, 'dragend', function() {
		var pos = marker.getPosition();
		set_contents('snaptest_arg_pt', sprintf("Arg pt: ( %.6f, %.6f )", pos.lat(), pos.lng()));
		forget_snapped_marker();
		forget_resnapped_markers();
		var snapped_pt = null;
		if(is_selected('useclientsidesnap_checkbox')) {
			var snap_result = g_snaptogridcache.snap(new LatLng(pos.lat(), pos.lng()), 1000);
			if(snap_result != null) {
				snapped_pt = [snap_result[0].lat, snap_result[0].lng];
				set_contents('snaptest_result_snappedpt', sprintf("Snapped (client-side): (%.6f, %.6f)", snap_result[0].lat, snap_result[0].lng));
				set_contents('snaptest_result_mofr', '');
				set_contents('snaptest_result_resnappedpts', '');
			}
		} else {
			var route = radio_val('fudgeroute');
			var snaptest_result = snaptest(pos, route);
			snapped_pt = snaptest_result[0];

			if(snaptest_result[0] != null) {
				set_contents('snaptest_result_snappedpt', sprintf("Snapped (server-side): (%.6f, %.6f)", snaptest_result[0][0], snaptest_result[0][1]));
			} else {
				set_contents('snaptest_result_snappedpt', 'no snapped point');
			}

			set_contents('snaptest_result_mofr', sprintf("mofr = %d", snaptest_result[1]));

			forget_resnapped_markers();
			for(var i=0; i<2; i++) {
				if(snaptest_result[2][i] != null) {
					//alert(snaptest_result[2][0] + 1);
					var newmarker = new google.maps.Marker({
						position: new google.maps.LatLng(snaptest_result[2][i][0], snaptest_result[2][i][1]), map: g_map, draggable: false, 
						icon: 'http://www.google.com/mapfiles/markerB.png', zIndex: 5
						});
					g_resnapped_markers[i] = newmarker;
				}
			}
			set_contents('snaptest_result_resnappedpts', snaptest_result[2]);
		}
		if(snapped_pt != null) {
			g_snapped_marker = new google.maps.Marker({
				position: new google.maps.LatLng(snapped_pt[0], snapped_pt[1]), map: g_map, draggable: false, 
				icon: 'http://www.google.com/mapfiles/markerA.png', zIndex: 10 
				});
		}
	});
}

function forget_snapped_marker() {
	if(g_snapped_marker != null) {
		g_snapped_marker.setMap(null);
		g_snapped_marker = null;
	}
}

function forget_resnapped_markers() {
	for(var i=0; i<2; i++) {
		if(g_resnapped_markers[i] != null) {
			g_resnapped_markers[i].setMap(null);
			delete g_resnapped_markers[i];
			g_resnapped_markers[i] = null;
		}
	}
}

function snaptest(glatlon_, fudgeroutename_) {
	return callpy_sync('routes.snaptest', fudgeroutename_, [glatlon_.lat(), glatlon_.lng()], 1);
}

function mofr_to_latlon(mofr_, fudgeroutename_) {
	var latlon = $.parseJSON(get_sync(sprintf('mofr-to-latlon.cgi?mofr=%d&fudgeroute=%s', mofr_, fudgeroutename_)));
	return (latlon==null ? null : new google.maps.LatLng(latlon[0], latlon[1]));
}

function make_vehicle_markers(vis_by_time_) {
	delete_vehicle_markers();
	for(var i=0; i<vis_by_time_.length; i++) {
		var vis = vis_by_time_[i];
		g_times.push(vis.length > 0 ? vis[0].timestr : null);
		var timeslice = new Array();
		g_vmarkers.push(timeslice);
		for(j=0; j<vis.length; j++) {
			vi = vis[j];
			var marker = make_vi_marker(vi);
			timeslice.push(marker);
		}
	}
}

function delete_vehicle_markers() {
	for(var i=0; i<g_vmarkers.length; ++i) {
		var timeslice = g_vmarkers[i];
		for(j=0; j<timeslice.length; ++j) {
			timeslice[j].setMap(null);
			delete(timeslice[j]);
		}
		delete(timeslice);
	}
	delete(g_vmarkers);
	g_vmarkers = new Array();

	delete(g_times);
	g_times = new Array();
}

function get_vi_marker_text(vi_) {
	return vi_to_str_short(vi_);
}

function set_contents(id_, contents_) {
	document.getElementById(id_).innerHTML = contents_;
}

function remove_objects_of_all_kinds() {
	remove_route_markers();
	remove_stop_markers();
	remove_lines();
}

function remove_route_markers() {
	remove_objects(g_route_markers);
}

function remove_stop_markers() {
	remove_objects(g_stop_markers);
}

function remove_lines() {
	remove_objects(g_lines);
}

function remove_objects(list_) {
	list_.forEach(function(marker) {
		marker.setMap(null);
	});
	list_.clear();
}

function refresh_config_route() {
	remove_objects_of_all_kinds();
	set_config_route(radio_val('configroute'), radio_val('configdirection'));
}

function refresh_fudge_route() {
	remove_objects_of_all_kinds();
	set_fudge_route_routepts(radio_val('fudgeroute'), (is_selected('dir0button') ? 0 : 1));
	set_fudge_route_stops_bothdirs(radio_val('fudgeroute'));
}

function set_fudge_route_stops_bothdirs(route_) {
	g_stops_dir_to_stoptag_to_latlng = null;
	g_stops_dir_to_stoptag_to_latlng = callpy_sync('routes.get_stops_dir_to_stoptag_to_latlng', route_);
	for(var dir=0; dir<=1; dir++) {
		var stoptag_to_latlng = g_stops_dir_to_stoptag_to_latlng[dir];
		for(var stoptag in stoptag_to_latlng) {
			var latlng = stoptag_to_latlng[stoptag];
			draw_stop(latlng, dir, stoptag);
		}
	}
}

function draw_stop(latlng_, dir_, stoptag_) {
	var size = 20;

	var mark=null;
	if(dir_==0) {
		mark = new RichMarker({
			position: new google.maps.LatLng(latlng_[0], latlng_[1]), 
			map: g_map,
			draggable: false,
			flat: true, 
			anchor: new google.maps.Size(-size/2, -size/2), 
			content: sprintf('<svg width="%d" height="%d" viewBox="0 0 100 100" version="1.1">' +
					'<polygon points="100,0 100,100 0,100" fill="rgb(0,255,0)" fill-opacity="0.5" stroke-width="0.5" />' +
					'<circle cx="50" cy="50" r="20" fill="rgb(0,255,0)" fill-opacity="1" stroke-width="1" stroke="rgb(0,0,0)" />' +
					'</svg>', size, size)
			});
	} else {
		mark = new RichMarker({
			position: new google.maps.LatLng(latlng_[0], latlng_[1]), 
			map: g_map,
			draggable: false,
			flat: true, 
			anchor: new google.maps.Size(-size/2, -size/2), 
			content: sprintf('<svg width="%d" height="%d" viewBox="0 0 100 100" version="1.1">' +
					'<polygon points="100,0 0,100 0,0" fill="rgb(0,0,255)" fill-opacity="0.5" stroke-width="0.5" />' +
					'<circle cx="50" cy="50" r="20" fill="rgb(0,0,255)" fill-opacity="1" stroke-width="1" stroke="rgb(0,0,0)" />' +
					'</svg>', size, size)
			});
	}
	g_stop_markers.add(mark);

	google.maps.event.addListener(mark, 'click', function() {
		alert(sprintf('stoptag: %s', stoptag_));
	});
}

function set_fudge_route_routepts(route_, dir_) {
	var route_points = callpy_sync('routes.routepts', route_, dir_);
	var glatlons = latlonfloatarrays_to_googlemaps(route_points);
	for(var i=0; i<glatlons.length; i++) {
		add_route_marker(glatlons[i]);
	}
	rebuild_snaptogridcache();
}

function latlonfloatarrays_to_googlemaps(l_) {
	var r = new Array();
	for(var i=0; i<l_.length; i++) {
		var pt = l_[i];
		r.push(new google.maps.LatLng(pt[0], pt[1]));
	}
	return r;
}

function path_direction_matches(path_xmlelem_, dir_) {
	var has_inbounds = false, has_outbounds = false;
	$(path_xmlelem_).find('tag').each(function() {
		if($(this).attr('id').indexOf('_0_') != -1) {
			has_inbounds = true;
		} else if($(this).attr('id').indexOf('_1_') != -1) {
			has_outbounds = true;
		}
	});
	if(dir_ == 'inbound') {
		return has_inbounds;
	} else if(dir_ == 'outbound') {
		return has_outbounds;
	} else {
		return true;
	}
}

function set_config_route(route_, direction_) {
	var route_doc = $.parseXML(get_sync(sprintf('config_route_%s.xml', route_)));
	var pathnum = 0;
	$(route_doc).find('path').each(function() {
		if(path_direction_matches(this, direction_)) {
			var path_points = new Array();
			$(this).find('point').each(function() {
				var lat = $(this).attr('lat'), lon = $(this).attr('lon');
				path_points.push(new google.maps.LatLng(lat, lon));
			});
			var color = int_to_rgbstr(pathnum);
			draw_path_polyline(path_points, color);
			pathnum += 1;
		}
	});
	/*
	$(route_doc).find('stop').each(function() {
		var lat = $(this).attr('lat'), lon = $(this).attr('lon');
		make_path_marker(lat, lon);
	});
	*/
}

function add_lines_based_on_route_markers() {
	for(var i=0; i<g_route_markers.size()-1; i++) {
		add_line(i);
	}
}

function add_line(i_) {
	var latlng1 = g_route_markers.elementAtIndex(i_).getPosition();
	var latlng2 = g_route_markers.elementAtIndex(i_+1).getPosition();
	var line = new google.maps.Polyline({
		clickable: true, 
		map: g_map, 
		path: [latlng1, latlng2], 
		strokeColor: 'rgb(255,0,0)', strokeWeight: 5
	});
	google.maps.event.addListener(line, 'click', function(e__) {
		split_line(i_, e__.latLng);
	});
	g_lines.add(line);
}

function split_line(lo_marker_ptaddr_, new_latlng_) {
	var marker_latlngs = new buckets.LinkedList();
	for(var i=0; i<g_route_markers.size(); i++) {
		var marker = g_route_markers.elementAtIndex(i);
		marker_latlngs.add(marker.getPosition());
		if(i == lo_marker_ptaddr_) {
			marker_latlngs.add(new_latlng_);
		}
	}

	remove_lines();
	remove_route_markers();

	marker_latlngs.forEach(function(latlng) {
		add_route_marker(latlng);
	});
	rebuild_snaptogridcache();
}

function radio_val(groupname_) {
	return $('input[name='+groupname_+']:checked').val();
}

function add_route_marker(glatlon_) {
	var glatlon = glatlon_;
	if(glatlon == null) {
		if(g_route_markers.size() == 0) {
			glatlon = g_map.getCenter();
		} else {
			if(g_route_markers.size() >= 2) {
				var pos1 = g_route_markers.elementAtIndex(g_route_markers.size()-2).getPosition();
				var pos2 = g_route_markers.elementAtIndex(g_route_markers.size()-1).getPosition();
				glatlon = new google.maps.LatLng(pos2.lat() + (pos2.lat() - pos1.lat()), pos2.lng() + (pos2.lng() - pos1.lng()));
			} else {
				var lastmarkpos = g_route_markers.elementAtIndex(g_route_markers.size()-1).getPosition();
				glatlon = new google.maps.LatLng(lastmarkpos.lat(), lastmarkpos.lng()+0.002);
			}
			glatlon = constrain_latlng_by_map_bounds(glatlon);
		}
	}

	var marker_ptaddr = g_route_markers.size();

	var marker = new google.maps.Marker({position: glatlon, map: g_map, title:''+(marker_ptaddr), draggable: true, zIndex: -10, 
		icon: 'http://www.google.com/mapfiles/marker.png'});

	g_route_markers.add(marker);

	google.maps.event.addListener(marker, 'drag', function() {
		redraw_buildfudgeroute_path();
	});

	google.maps.event.addListener(marker, 'click', function() {
		delete_marker(marker_ptaddr);
	});

	redraw_buildfudgeroute_path();
}

function delete_marker(marker_ptaddr_) {
	var marker_latlngs = new buckets.LinkedList();
	for(var i=0; i<g_route_markers.size(); i++) {
		var marker = g_route_markers.elementAtIndex(i);
		if(i == marker_ptaddr_) {
			continue;
		}
		marker_latlngs.add(marker.getPosition());
	}

	remove_lines();
	remove_route_markers();

	marker_latlngs.forEach(function(latlng) {
		add_route_marker(latlng);
	});

	rebuild_snaptogridcache();
}

function rebuild_snaptogridcache() {
	var marker_latlngs = [];
	g_route_markers.forEach(function(marker) {
		var google_latlng = marker.getPosition();
		marker_latlngs.push(new LatLng(google_latlng.lat(), google_latlng.lng()));
	});

	g_snaptogridcache = new SnapToGridCache([marker_latlngs]);
}

function constrain_latlng_by_map_bounds(latlng_) {
	var top = g_map.getBounds().getNorthEast().lat();
	var bottom = g_map.getBounds().getSouthWest().lat();
	var left = g_map.getBounds().getSouthWest().lng();
	var right = g_map.getBounds().getNorthEast().lng();
	var MARGIN = 0.2;
	var margin_top = top - (top - bottom)*MARGIN;
	var margin_bottom = bottom + (top - bottom)*MARGIN;
	var margin_left = left + (right - left)*MARGIN;
	var margin_right = right - (right - left)*MARGIN;
	var r = latlng_;
	if(latlng_.lat() > margin_top) {
		r = new google.maps.LatLng(margin_top, latlng_.lng());
	}
	if(latlng_.lat() < bottom) {
		r = new google.maps.LatLng(margin_bottom, latlng_.lng());
	}
	if(latlng_.lng() < margin_left) {
		r = new google.maps.LatLng(latlng_.lat(), margin_left);
	}
	if(latlng_.lng() > margin_right) {
		r = new google.maps.LatLng(latlng_.lat(), margin_right);
	}
	return r;
}

function redraw_buildfudgeroute_path() {
	remove_lines();

	add_lines_based_on_route_markers();

	var str_repr = '[<br/>';
	for(var i=0; i<g_route_markers.size(); i++) {
		var m = g_route_markers.elementAtIndex(i);
		str_repr += sprintf('[%.6f, %.6f]%s <br/>', m.getPosition().lat(), m.getPosition().lng(), 
			(i<g_route_markers.size()-1 ? ',' : ''));
	}
	str_repr += ']<br/>';
	set_contents('results', str_repr);

	show_route_dist_m();
}

function show_route_dist_m() {
	var pts = [];
	g_route_markers.forEach(function(marker) {
		pts.push(marker.getPosition());
	});
	set_contents('dist', dist_m_polyline(pts));
}

function on_zoom_changed() {
	set_contents('p_zoom', "Zoom: "+(g_map.getZoom()));
}

function on_add_marker_button_clicked() {
	add_route_marker(null);
	rebuild_snaptogridcache();
}

    </script>
  </head>
  <body onload="initialize()">
		<div id="map_canvas" style="width:80%; height:100%"></div>
    <div style="position:absolute; top:0; right:0; height:100%;">
			<form name="form2">
      <table border="1">
				<tr>
					<td>
						Config routes: 
					</td>
				</tr>
				<tr>
					<td>
						<input type="radio" name="configroute" value="504" />504<br/>
						<input type="radio" name="configroute" value="501" />501<br/>
						<input type="radio" name="configroute" value="301" />301<br/>
						<input type="radio" name="configroute" value="505" checked="checked" />505<br/>
					</td>
				</tr>
				<tr>
					<td>
						<input type="radio" name="configdirection" id="directioninbound" value="inbound" checked="checked"  />Inbound (west)<br/>
						<input type="radio" name="configdirection" id="directionoutbound" value="outbound"                  />Outbound (east)<br/>
						<input type="radio" name="configdirection" id="directionboth" value="both"                          />Both<br/>
					</td>
				</tr>
				<tr>
					<td>
						<input type="button" onclick="refresh_config_route()" value="Submit" />
					</td>
				</tr>
      </table>
			</form>
			<br/>
			<form name="form3">
      <table border="1">
				<tr>
					<td>
						Fudge routes: 
					</td>
				</tr>
				<tr>
					<td>
						<input id="bathurstradiobutton" type="radio" name="fudgeroute" value="bathurst" /><label for="bathurstradiobutton">Bathurst</label><br/>
						<input id="carltonradiobutton" type="radio" name="fudgeroute" value="carlton" /><label for="carltonradiobutton">Carlton</label><br/>
						<input id="dufferinradiobutton" type="radio" name="fudgeroute" value="dufferin" /><label for="dufferinradiobutton">Dufferin</label><br/>
						<input id="dundasradiobutton" type="radio" name="fudgeroute" value="dundas" checked="checked" /><label for="dundasradiobutton">Dundas</label><br/>
						<input id="dupontradiobutton" type="radio" name="fudgeroute" value="dupont" /><label for="dupontradiobutton">Dupont</label><br/>
						<input id="keeleradiobutton" type="radio" name="fudgeroute" value="keele" /><label for="keeleradiobutton">Keele</label><br/>
						<input id="kingradiobutton" type="radio" name="fudgeroute" value="king" /><label for="kingradiobutton">King</label><br/>
						<input id="lansdowneradiobutton" type="radio" name="fudgeroute" value="lansdowne" /><label for="lansdowneradiobutton">Lansdowne</label><br/>
						<input id="ossingtonradiobutton" type="radio" name="fudgeroute" value="ossington" /><label for="ossingtonradiobutton">Ossington</label><br/>
						<input id="queenradiobutton" type="radio" name="fudgeroute" value="queen" /><label for="queenradiobutton">Queen</label><br/>
						<input id="spadinaradiobutton" type="radio" name="fudgeroute" value="spadina" /><label for="spadinaradiobutton">Spadina</label><br/>
						<input id="stclairradiobutton" type="radio" name="fudgeroute" value="stclair" checked="checked" /><label for="stclairradiobutton">St. Clair</label><br/>
						<input id="bloordanforthradiobutton" type="radio" name="fudgeroute" value="bloor_danforth" /><label for="bloordanforthradiobutton">Bloor Danforth</label><br/>
						<input id="yongeuniversityspadinaradiobutton" type="radio" name="fudgeroute" value="yonge_university_spadina" /><label for="yongeuniversityspadinaradiobutton">Yonge University Spadina</label><br/>
					</td>
				</tr>
					<td>
						<input id="dir0button" type="radio" name="dir" value="dir0button" checked="checked" /><label for="dir0button">dir 0</label><br/>
						<input id="dir1button" type="radio" name="dir" value="dir1button" /><label for="dir1button">dir 1</label><br/>
					</td>
				<tr>
					<td>
						<input type="button" onclick="refresh_fudge_route()" value="Submit" />
					</td>
				</tr>
      </table>
			</form>
			<br/>
			<form name="form3">
      <table border="1">
				<tr>
					<td>
						Build fudge route:  <input id="add_marker_button" type="button" onclick="on_add_marker_button_clicked" value="Add marker" /><br/>
						(Or press the spacebar.)
					</td>
				</tr>
				<tr>
					<td>
						<label for="useclientsidesnap_checkbox">Use client-side snap:</label>
						<input type="checkbox" id="useclientsidesnap_checkbox" name="useclientsidesnap_checkbox" checked="checked"/>
					</td>
				</tr>
      </table>
			</form>
    </div>
		<div>
			<p id="p_zoom">zoom...</p>
			<form name="form1">
				stoptag:<input type="text" size="15" name="stoptag_field" id="stoptag_field" /> 
				<input type="button" onclick="show_stoptag(this.form.stoptag_field.value)" value="Submit" id="stoptag_submit_button" /><br/>
			</form>
			<p id="dist">...</p>
			<p id="snaptest_arg_pt">...</p>
			<p id="snaptest_result_snappedpt">...</p>
			<p id="snaptest_result_mofr">...</p>
			<p id="snaptest_result_resnappedpts">...</p>
			<p id="results">Results will go here</p>
		</div>
  </body>
</html>
