<!DOCTYPE html>
<html>
  <head>
		<title>test</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 70%; margin: 0; padding: 0 }
    </style>
    <script type="text/javascript"
		      src="http://maps.googleapis.com/maps/api/js?sensor=false">
					    </script>
		<script type="text/javascript" src="js/richmarker-compiled.js"></script>
		<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="common.js"></script>
    <script type="text/javascript">


var g_marker = null;
var g_geocoder = new google.maps.Geocoder();

function initialize() {

	init_map();

	g_marker = new google.maps.Marker({
		position: new google.maps.LatLng(43.650757399103135, -79.413822128378385),
		map: g_map,
		title:"",
		draggable: true
		});

	google.maps.event.addListener(g_marker, 'drag', show_latlng_text);

	google.maps.event.addListener(g_map, 'zoom_changed', on_zoom_changed);

	on_zoom_changed();
	show_latlng_text();

	$('#search_textfield').keydown(function (e){
		if(e.keyCode == 13) {
			$('#search_button').trigger('click');
		}
	});

	document.getElementById('search_textfield').focus();
	document.getElementById('search_textfield').select();

}

function on_zoom_changed() {
	set_contents('p_zoom', "Zoom: "+(g_map.getZoom())); 
}

function show_latlng_text() {
	set_contents('p_latlng', sprintf("Marker's position:   %.7f, %.7f", g_marker.getPosition().lat(), g_marker.getPosition().lng()));
}

function search() {
		var string_to_search = document.getElementById('search_textfield').value;
		var regex = /([-]?\d+\.\d+)[ ,]*([-]?\d+\.\d+)/g;
		var match = regex.exec(string_to_search);
		if(match != null) {
			var lat = parseFloat(match[1], 10);
			var lng = parseFloat(match[2], 10);
			g_marker.setPosition(new google.maps.LatLng(lat, lng));
			on_marker_moved_via_text_textfield();
		} else {
			g_geocoder.geocode(
					{'address': string_to_search}, 
					function(results, status) { 
							if (status == google.maps.GeocoderStatus.OK) { 
									var pos = results[0].geometry.location;
									g_marker.setPosition(pos);
									on_marker_moved_via_text_textfield();
							} 
							else {
									alert("Not found: " + status); 
							} 
					}
			);
		}
};

function on_marker_moved_via_text_textfield() {
	show_latlng_text();
	pan_to_marker_maybe();
}

function pan_to_marker_maybe() {
	var sw = g_map.getBounds().getSouthWest(), ne = g_map.getBounds().getNorthEast();
	var pos = g_marker.getPosition();
	if(pos.lat() < sw.lat() || pos.lat() > ne.lat() || pos.lng() < sw.lng() || pos.lng() > ne.lng()) {
		g_map.panTo(pos);
	}
}



    </script>
  </head>
  <body onload="initialize()" >
		<div id="map_canvas" style="width:80%; height:100%"></div>
		<p id="p_zoom"/>
		<p id="p_latlng"/>
		<form name="form1">
			<input type="text" size="60" name="search_textfield" id="search_textfield" />
			<input id="search_button" type="button" value="Search" onclick="search(); return false;"/> 
			
			<!-- If I don't put this here, then pressing enter while in the above (important) text field makes the page reload.  
				I don't know why. --> 
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" size="5" value="dummy" /> 

		</form>

  </body>
</html>
